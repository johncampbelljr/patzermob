<html>
	<head>
		<title>Community Chess</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript" ></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
		<script src="chess/chess.js" type="text/javascript" ></script>
		<script src="socket.io/socket.io.js"></script>
		<link rel="stylesheet" type="text/css" href="board.css" />
	</head>
	<body>
<!-- grabbed the chess board from http://designindevelopment.com/css/css3-chess-board/ -->
<div id="board_container">
	<table id="chess_board" cellpadding="0" cellspacing="0">
	<tr>
		<td id="A8"/>
		<td id="B8"/>
		<td id="C8"/>
		<td id="D8"/>
		<td id="E8"/>
		<td id="F8"/>
		<td id="G8"/>
		<td id="H8"/>
	</tr>
	<tr>
		<td id="A7"/>
		<td id="B7"/>
		<td id="C7"/>
		<td id="D7"/>
		<td id="E7"/>
		<td id="F7"/>
		<td id="G7"/>
		<td id="H7"/>
	</tr>
	<tr>
		<td id="A6"/>
		<td id="B6"/>
		<td id="C6"/>
		<td id="D6"/>
		<td id="E6"/>
		<td id="F6"/>
		<td id="G6"/>
		<td id="H6"/>
	</tr>
	<tr>
		<td id="A5"/>
		<td id="B5"/>
		<td id="C5"/>
		<td id="D5"/>
		<td id="E5"/>
		<td id="F5"/>
		<td id="G5"/>
		<td id="H5"/>
	</tr>
	<tr>
		<td id="A4"/>
		<td id="B4"/>
		<td id="C4"/>
		<td id="D4"/>
		<td id="E4"/>
		<td id="F4"/>
		<td id="G4"/>
		<td id="H4"/>
	</tr>
	<tr>
		<td id="A3"/>
		<td id="B3"/>
		<td id="C3"/>
		<td id="D3"/>
		<td id="E3"/>
		<td id="F3"/>
		<td id="G3"/>
		<td id="H3"/>
	</tr>
	<tr>
		<td id="A2"/>
		<td id="B2"/>
		<td id="C2"/>
		<td id="D2"/>
		<td id="E2"/>
		<td id="F2"/>
		<td id="G2"/>
		<td id="H2"/>
	</tr>
	<tr>
		<td id="A1"/>
		<td id="B1"/>
		<td id="C1"/>
		<td id="D1"/>
		<td id="E1"/>
		<td id="F1"/>
		<td id="G1"/>
		<td id="H1"/>
	</tr>
</table>
</div>
<div id="info_container">
	<div id="turn"></div>
	<div id="vote_count"></div>
	<div id="check"></div>
	<div id="mate"></div>
	<div id="list"></div>
</div>
</body>
<script>

var fenChars = "KQRBNPkqrbnp";
var colChars = "ABCDEFGH";
var chess = new Chess();

function getChessFontCharFromFen(fenChar) {
	return String.fromCharCode(9812 + this.fenChars.indexOf(fenChar));
}

// state when waiting for the other side to move
function awaitingMove() {
}

function postMove() {
}

var highlightList = [];

var from;
function unHighlight()
{
	for(hl in highlightList) {
		var item = highlightList[hl];
		item.attr("style","");
		item.off('click');
	}
	highlightList = [];
}

function makeMove(event) {
	var url = 'ajax/move';
	$.ajax({
	  type: 'POST',
	  url: url,
	  data: "from=" + from.toLowerCase() +"&to=" + $(event.target).attr("id").toLowerCase() + "&promotion=q",
	  success: function(data) {
	  }
	});
	unHighlight();	
}

function fromMoveClick(event)
{
	unHighlight();
	var target = $(event.target);
	from = target.attr("id");
	target.attr("style","background-image: none; background-color: rgb(255, 255, 161);");
	highlightList.push(target);

	var list = "";	
	var moves = chess.moves({ target: $(event.target).attr("id").toLowerCase()});
	for(move in moves) {
		var clean = moves[move].replace(/#/g,"").replace(/\+/g,"").replace(/Q/g,"").replace(/\=/g,"");
		list += " " + moves[move];
		if (clean == "O-O") {
			clean = "g1";
		}
		if (clean == "O-O-O") {
			clean = "c1";
		}
		var id = "#" + clean.substr(clean.length-2)
		target = $(id.toUpperCase());
		target.attr("style","background-image: none; background-color: rgb(255, 255, 161);");
		target.click(makeMove);
		highlightList.push(target);
	}
	$("#list").text(list);
}

var side = 'w';

function isMyPiece(fenPiece)
{
	var whitePieces = "KQRBNP";
	return (whitePieces.match(fenPiece) && side == 'w' );
}
function updateInfo(data)
{
		if ( data.turn == 'b' ) {
			$("#turn").text("Turn: Black");
		} else {
			$("#turn").text("Turn: White");
		}
		$("#vote_count").text("Vote Count: " + data.vote_count);
	if ( data.inCheck ) {
		$("#check").text("CHECK");
	} else {
		$("#check").text("");
	}
	if ( data.inCheckmate ) {
		$("#mate").text("CHECKMATE");
	} else {
		$("#mate").text("");
	}
}
$(function() {
	$('td').addClass('piece');
	$.ajax({
	  url: 'ajax/board',
	    	success: function(data) {
			displayFen(data.board);
		}
	});

	var socket = io.connect('http://localhost');
      	socket.on('notification', function (data) {
		updateInfo(data);
      	});
      	socket.on('move_complete', function (data) {
		updateInfo(data);
		displayFen(data.board);
      	});
	socket.on('vote_update', function(data) {
		updateInfo(data);
		$("#vote_count").text("Vote Count: " + data.vote_count);
	});
});

function displayFen(fenString) {
	chess = new Chess(fenString);
	$("td").text("").off('click');;
	var ranks = fenString.split(/\s/g)[0].split("/");
	ranks.forEach(function(element, index, array) {
		var colNo = 0;
		for (var idx = 0; idx < element.length; idx++) {
			var char = element.charAt(idx);
			if ( char.match(/[0-8]/) ) {
				colNo+=char/1;
				continue;
			}
			id = "#" + colChars.charAt(colNo) + (8 - index); 
			var item = $(id);
			item.text(getChessFontCharFromFen(char));
			
			if ( isMyPiece(char) ) {
				item.click(fromMoveClick);
			}

			colNo++;		
		}
	});
}
</script>
</html>
